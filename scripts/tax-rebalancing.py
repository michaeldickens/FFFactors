"""
tax-rebalancing.py
------------------

Author: Michael Dickens <mdickens93@gmail.com>
Created: 2015-12-26

Module for calculating taxes incurred if you donate the biggest
winners each time you rebalance.

""" 

import numpy as np

rets = [
        [-0.194873827454089,-0.38276706458524645,-0.5753822314049588,-0.13361999462510088,1.2086230502832418e-2,0.4777950138504157,-0.3311188004613611,-0.1738463173557233,-0.12004554629677555,2.1484375e-2,-0.282374492642569,-0.1425068312171197,-0.268998724489796,-0.6109634527089074,-0.22559140441378467,-0.5493469387755102,-7.799703703703709e-2,-0.14240916955017302,-0.21291048977294047,-0.13032069544890057,-0.4514500881269027,-3.3262822876438336e-2,-0.25111823241693365,-0.3760801655239564,-0.16289846842328604,-8.495999999999992e-2,0.13931947069943273,0.263214753123141,-0.19757866875796481,-8.87566924449732e-2],
        [0.35558024691358003,0.6157534945413736,1.1130434782608694,8.994082840236617e-3,-0.10763219686296621,1.1935076177285322,0.6068929612661391,0.20857283950617278,1.3684413235265573,0.771904266389178,1.7254362263579202,0.2795889698231009,-4.1002154126802526e-2,0.6125518120948028,0.3520546769996282,1.6277343749999997,0.4438069745713493,0.5705589177643289,0.3808837890625001,0.3232142857142857,0.22237611572791627,1.2241481882098433,1.085975171847748,0.5064165235389968,0.8488888888888886,1.1006388193297458,0.31957369614512476,1.245972222222222,0.28399176551318495,0.282798833819242],
        [0.5137326515704896,0.44779083105889805,0.37032653061224474,0.0,-0.14667622041420125,0.28734129858798885,0.14088808833894606,0.4650940559323733,0.7262469135802472,0.2543518788886143,0.2561686410522048,9.486290457426438e-2,0.5716339480467976,0.6353517751479287,5.242000000000013e-2,0.4796494473069979,0.30516551303841877,0.4057083880653034,0.4954444444444446,0.2389802289281997,-8.527403437347014e-2,0.1671268241959194,0.1685683839992338,0.23182993392703244,0.47346296296296275,0.3935397638672311,0.4683906957524835,2.4891761274271396e-2,0.7847936177592787,0.2234112828643149],
        [0.17296514259846107,0.2677685950413222,0.2655366677754243,-1.4713541666666718e-2,0.1368302563771846,-5.4412437128486424e-2,-7.084173402827632e-2,0.11512168701011927,6.022490628904631e-2,0.1517678053533036,-0.10596751115226,0.24460008282415835,4.429413805064186e-2,1.6833423472147224e-2,0.23719181398424705,4.403276622558305e-2,2.2071911712353565e-3,0.22916666666666674,3.333333333332966e-5,0.18458974610332346,0.1444027047332832,-0.2741691927383363,0.22394780844823337,0.0,-0.14833204851351933,2.8968328777453145e-2,-0.21253453795886157,0.1516633010946966,-0.21795041322314046,-7.157024793388422e-2],
        [0.6206521739130435,9.72588109647563e-2,3.1858407079645934e-2,0.21581003162006307,6.0728836577636836e-2,9.543880372627433e-2,9.430064092292922e-2,2.0927894283251813e-2,0.44165469692617076,-8.846011131725429e-2,-3.1568195601519355e-2,0.22111620158267398,6.400226223018279e-3,2.5221068819684778e-2,0.1297668038408777,-6.338305006359113e-2,0.19765639084189668,-9.424176296694442e-2,0.609027241296336,5.933827104006406e-2,0.3724666337123086,1.614471398716049,0.12196863169280703,5.990686600609241e-2,0.30207925444435735,-4.76363636363637e-2,0.2738636363636364,0.41390570934256066,3.677250247818886e-2,-0.1816417331063931],
        [0.18138369965729595,0.9491581173153731,-8.748845798707283e-2,0.5631709010134669,0.1866865063826455,0.20739932553064855,0.26485215794306716,0.5092986280712681,0.8884573039150923,8.068707725169122e-2,0.2156811421772753,0.15776884619154985,8.694224893310776e-2,0.671940775148788,0.2865090084933952,0.1673526069940665,0.34881280000000014,0.10457019658962707,0.531987513007284,0.0,0.18019040964276334,-0.10657856937661592,0.25344042838018743,0.11355500123351892,0.5786170580468482,0.1278206097253718,0.1465277777777778,0.2240096850575939,0.1280583613916948,0.17442622950819686],
        [1.0384008290816324,-3.4209157127991774e-2,0.35975975975975993,0.15016821075513698,9.552222592934578e-2,0.2551468731588249,0.33135759750523297,0.4797136713444998,0.15856781977566214,0.26187043444828917,0.40670138888888885,0.12078609221466374,6.104126269260446e-2,5.7175323855458204e-2,0.1858131487889274,-7.604646066184528e-2,0.1382367929335826,7.80550903141024e-2,0.1495152354570639,0.19483929379809872,0.5467820443482965,0.5355142690847279,-6.673076923076937e-2,-7.583102493074789e-2,1.129387464006025,0.5131452528605118,-0.12049146410041489,-1.4694029388058638e-2,0.3895511087074095,0.22631506715027938],
        [2.9296875e-2,-0.14473684210526316,-0.17348304580606777,0.7577499999999997,0.19285950413223119,0.5964577714540549,0.3043540945790082,0.7128635921280273,0.4637779656607701,0.177578282102844,0.3813738673469387,-0.13683071930773394,-0.1399900861163621,-0.2992887211496589,0.1447460937499998,0.3054633608815429,-0.19294117647058828,9.995274102079388e-2,4.185864130967554e-2,0.8831494791836736,0.12774059148965233,0.38254140664530256,0.21659574886253097,0.6296966953372567,-0.24629516601562507,8.89807162534435e-2,0.13849943226482675,0.19491030291147915,0.25529570270868107,0.36991441689623494],
        [0.25081151999999984,0.36050988553590013,0.0,3.387243576279486e-2,0.31192743764172337,1.0450073393804806,0.7668718877320055,0.7195644362511524,-0.1750600020870292,0.22360000000000002,0.5729286586429445,0.15544399999999992,1.1341512724652048,0.5221547638874167,0.9932028321532693,-0.30785783701235603,4.598130841121506e-2,0.37356419595354784,1.5142857142857125e-2,1.0841576587940773,-0.2837233571003406,0.5570385110048774,0.0,1.362311111111111,0.5913376871230154,0.196639231824417,-9.397808619430237e-2,0.7051592812355345,0.4062068232543312,0.36539428571428556],
        [0.0,0.6216449357291409,0.11799458467988444,0.11457488791645432,0.7099609375,0.38346437251649235,0.2514271145698017,0.963946436969382,0.48225880201188853,0.5904679174768315,-0.22089991177335555,8.45140619437521e-2,0.37450754458161883,0.3706054795124425,0.8193351026823672,-8.39566847147023e-2,0.24696115020833176,0.5554730983302412,0.356300215559475,0.26010848126232755,1.6308461883213443e-2,0.5803809171597636,0.6053393382122974,4.989411335145455e-2,0.22014742014742006,0.45627641589180046,0.5274275516274325,0.1540350877192984,0.7736624126234515,0.0],
        [0.0,0.0,-8.290345227557117e-3,0.36788091715976345,0.41385041551246515,0.30330563250230846,0.1617251635930994,3.7496067945894884e-2,-0.11244998461064948,0.0,0.1891140311778876,0.28469685902118336,0.38419356662332516,-0.24520905770635504,0.4397658536585365,-0.3298724489795918,-0.3969288533333334,-0.16916060095378105,0.11877301775147941,0.44341292517006803,0.0,0.1643781162488902,-4.3577777777777604e-2,4.989411335145455e-2,-0.24046017298886313,0.22251007793603872,1.5608740894901052e-2,-0.11847632609469572,0.19046384102235625,-0.3224812726201498],
        [0.0,0.3834341274349291,0.0,0.2368135336447419,0.0,0.4246531906460562,-2.9289795918367223e-2,0.8174371922737029,0.41432043516839623,0.6234220907297827,0.3264554096876413,0.21413317078418004,0.0,0.3428963580069586,-4.796844733832761e-2,0.27849151234567904,0.3624186556927298,0.16097448979591822,0.766508875739645,0.8568864891857306,0.29620447450572307,0.7506033892847077,0.7856797783933518,0.6215116048403098,0.39084705882352955,0.22339555555555557,0.7376242945444773,0.7723510984623574,0.6809917355371902,-1.3735950413223175e-2],
        [0.2749541091387244,0.2221446225549042,0.1009606241145764,0.1592968749999999,0.2235666666666667,0.18018937002903668,0.0,5.268078889700534e-2,5.4255820529738985e-2,0.0,1.1228164471916102e-2,-0.10099632372529177,0.3031935355938926,0.20728447899379887,8.417489840740999e-2,0.1709763313609467,0.5749587436784671,0.24696976593547038,3.0953520661156864e-2,0.21286096907718544,-0.26472303206997094,0.5898654567507469,-7.781193135690478e-2,0.3091341192870316,0.5598557692307693,6.467077286855694e-2,-5.550735436719689e-3,0.4906240523186056,0.2275562955254944,2.0261705074185343e-2],
        [-0.4827594973199405,-6.202737552073012e-2,0.36505252988769477,0.0,-0.2116774009068504,0.1959566074950687,0.0,-0.30692901234567893,0.10486349206349188,1.1568181818181822,0.1423530662132002,0.3570944827217861,0.10563179008625889,-0.31807372175980975,4.006046863189705e-2,-8.799500000000005e-2,4.683837429111537e-2,-0.228839553703727,-0.21084214257417477,-0.17696,-0.37661941777168106,-0.23852941176470588,0.172360726377347,5.234910836762641e-3,4.785652892561982,0.0,0.6661706448953328,1.7881944444444464e-2,0.1845241638240882,-0.14442252903791364],
        [0.5674999999999999,-0.3259113614624296,0.14061654948620883,0.2633833333333335,-0.3616497383810402,0.519366327402045,0.7868619791666664,0.38216659904497363,0.49431395890481866,0.0,0.5727376977790684,8.119953863898499e-2,0.40618743995108764,0.11749005203550666,0.17321109693877546,0.5245102408351394,7.347722017120395e-2,0.14473281880307254,0.0,-0.1518668252080857,-3.6436644854253464e-2,0.40434396557612184,0.3211914062500001,-8.650519031142556e-4,2.444444444444449e-2,0.3463244121177884,1.4229112699353954,0.3040816326530611,0.3591206835172658,0.4586044081632654],
        [0.18200661428006115,0.4681556162337508,0.5364850055146095,1.0788894898143142,8.78458049886619e-2,0.4769941858873139,0.0,0.26962187871581444,0.4259938731131254,0.4545272802998752,0.45304351851851843,0.0,-0.25297418630751967,2.0000240346098384,0.174210197710718,-0.226808872793119,0.37762343299931,0.2570239334027056,0.47743055555555536,-2.4709141274238178e-2,-0.22933759784529917,0.0,0.1770773000668302,-0.16465769045217327,-0.17141403533337995,-0.2384811384419775,0.3130698224852071,-0.20982310093652445,0.39401780623656846,-0.6664472532474353],
        [-0.1495043731778426,0.13982289318040708,0.16586316481099894,0.22516838199257871,-0.3878737997256517,-9.84061547394397e-2,-0.14412070759625395,0.6424012979989184,0.3523128888888887,0.15104282352941167,-8.192913054456707e-2,0.44665584516289103,4.029937116623583e-2,0.30432691493505404,-0.23778612244897968,4.8929898756888246e-2,-0.4123017012991158,-0.20375,-4.652344317027157e-2,-0.5315992438563327,0.1304705246078961,-1.7455101576869803e-2,-0.2600997229916898,0.11680537055783491,-5.175386444708685e-2,4.2994444444444335e-2,-0.41673317930406784,-0.3536686390532544,-0.34479250334672007,-0.13671142845551554],
        [6.85519505112997e-3,0.6831796454514663,7.323847750865053,0.5868573087530844,0.9806998319818832,0.3182755116852951,0.6062454346238129,5.634122287968446e-2,0.26913805697589477,0.6653441777425113,0.41699346405228743,0.2827296171394562,0.2219021967847825,0.3454999999999999,0.10660715957679212,-0.10556799999999988,-0.12856496152105013,-0.31376925619834717,0.7370557327828859,0.24591026709354868,0.8959664599528345,0.40953403977355207,0.56028204267269,8.590692309016723e-2,0.281834151614792,0.4139123847998991,0.4321736189001051,0.39777176852352625,0.6115482290042327,0.7834104308390022],
        [0.13932879818594102,0.3487333931393908,0.15542486405750444,-0.14937823583490584,1.5264389629033106,0.0,0.2658810785185186,0.0,0.14993752603082044,6.758056057339301e-2,7.785467128027679e-2,0.5588949773995606,0.6505081081081081,-0.6372472479796325,0.2761481481481485,0.1718805786395814,0.16368284023668633,0.14051607062019,-6.1919879062736105e-2,0.12212846009137346,0.34965668371073777,-0.10368714804779677,0.12310950413223143,0.5125863221207394,0.43594182825484773,0.32446154932561266,0.22088847850620708,0.4566576482830387,-6.982954545454556e-2,0.12333425126614883],
        [4.375255,1.9279768982503942e-2,0.6498216409036863,0.35281568659473894,0.21162381499569083,0.6415837868267966,-0.14301620066303866,0.31848569013404204,0.44912396694214873,0.3537015873015874,8.122717311906502e-3,0.10634215500945188,-8.861960270223102e-2,0.9078869165023011,0.8367672563302113,-0.3286428571428571,0.47623309053069707,-8.394422476586882e-2,7.631486495666784e-2,-0.20065052855445054,-0.1408108108108107,0.6780508121615993,0.19120370370370376,0.10998921674345663,-7.742541632058397e-2,0.7618509813497756,0.28425572824867795,0.6179817331254178,0.9445759999999999,1.7504269965322727e-3],
        [-0.1789652978352254,8.116379025325648e-2,-0.10902872088929128,0.18885381682280755,-0.3058809322545586,-2.698925670364216e-2,-0.1074330489982146,-0.49992602040816325,5.580715850986184e-3,0.4612577335734982,-0.10189999999999999,0.13225611394786352,0.4727529909445436,1.1337868480725488e-2,-0.49044010409219596,-3.886112661864616e-2,-1.317931443276521e-3,0.6433887517146777,7.610003559985756e-2,-0.23857142857142843,-0.13061402235447805,0.32554637281910015,7.0555850781167e-2,4.823883401751661e-2,0.26815561337462124,0.17725068950500789,-0.19013079667063026,1.7879203072705963e-3,0.0,-2.893708466212641e-2],
        [1.6838438089710195e-3,0.36244158265835313,2.7462151751321384e-2,0.679622699741522,-0.21625000000000005,0.5555609340810108,-0.4019234404536862,-0.6951925078043706,5.558035281103768e-3,2.4688000000000043e-2,-5.1200158698670784e-2,0.1844999999999999,0.14479547114682245,0.8522777777777779,-0.16885546875000002,0.2819979188345474,0.1779100460638683,0.4943153732081069,0.6316290130796669,-0.46586995884773674,-0.1548171179829272,0.0,0.7003266160004009,0.19468571428571435,0.7849009122365522,0.9904305011993435,-0.12071152217211156,0.24489211526473476,-2.1133217993079545e-2,-0.10997711590531922],
        [-4.9951965493579054e-2,0.29262187500000003,3.1378323074984245,0.1417980368828078,-0.3058939645383877,-8.892053320675553e-3,8.303442589156895e-2,-3.740108288213251e-2,0.7407407407407407,0.22036289737262282,0.45665764828303845,-8.213671344499762e-2,0.14318840579710157,0.13408304498269885,-0.23569005701172507,0.6970199000098032,-0.22712390011890615,0.1338736979166666,0.767524588576108,0.34522940268734237,0.2919102596140499,0.480002903178981,8.410318860054322e-2,2.6304347826086927e-2,-5.701412809224715e-2,0.6726823810809766,-8.26931949250288e-2,0.22797187669010266,-0.17835634451019067,0.48791726611204944],
        [0.7654214876033056,0.11515799599557042,-4.838076407033409e-2,0.3107213714427428,0.13804713804713797,0.7789402083333332,3.857958700453068e-2,0.8264919947154963,0.12683321568154815,1.277366623576485,0.24847429016620515,6.45189568266491e-3,-0.125447477465932,0.32853509076193776,0.3923291428571427,5.046903659708257e-2,0.3993055555555558,0.22352275257210308,9.1909291562835e-3,0.2554563688862437,0.32122433891595015,-0.22690972222222228,0.359568611865019,6.907041906958877e-2,0.6532629029348864,0.5309800184349074,0.27584058469135786,0.0,0.2375799114049586,0.4051129607609989],
        [-0.5268446235205237,0.13189033817475426,0.12328970850684118,0.20760330578512387,6.239658079710386e-2,-7.426723384418166e-2,-0.22792034238798153,-2.004733727810637e-2,0.37761139958942147,0.0,-9.50949168598817e-2,2.4113107571344106e-3,7.273468912068148e-3,-0.4397959183673469,7.772273396070628e-2,3.612001307878199e-2,-0.5109335963182117,-0.6710146593185995,-0.3602801567716649,-0.2760029987505207,-0.10937278106508863,-0.2950147226729163,-1.01344857193848e-2,0.9769842046947872,-0.4454711135734073,0.0,-8.157097505668931e-2,0.3225054945054946,0.1291566974806586,-4.25312883457869e-2],
        [-0.1280776739106131,3.657187500000014e-2,0.2307444235420586,-0.26290650887573974,0.7800977716262976,-0.20013556877591498,-0.6159766763848397,0.14380408163265335,3.81121117811527e-2,-0.23342807711319824,-0.2788119664813219,0.8480281531107681,4.71978621701985e-3,-0.33102823149226435,0.15314622000905387,0.30728796825781113,-0.24780876059044443,2.9914933837428936e-2,1.245885568856631,1.83128,-9.572358176662465e-2,0.5185847341691499,-0.5012729795352064,0.11097693515275942,-0.64989010989011,-0.17648654786597828,0.8768379259259258,-0.20672130698171653,-0.10411032990805846,0.0],
        [-8.686272564967268e-2,0.1592342789129142,-0.4140973010743295,0.20764448933215496,0.32842351963925465,-8.828047892636293e-2,-0.16945903123585326,-0.12047508797743378,0.19040000000000012,0.48874937804218477,0.1970284879474069,0.35547176925252133,-0.2623813002191382,0.6971350000000001,0.17514360915810356,0.1132634055484758,-0.17071201814058945,-1.7076397294410683e-2,-0.2966054231268356,0.20392066540642717,-0.6020970985349038,-0.23592082440567286,0.682304132231405,-5.358289607643518e-2,2.009204768371812,0.15937397357312788,0.1100591715976329,-0.28711734693877544,0.6149521486207543,0.6035415110600406],
        [0.8993600000000002,0.0,0.47927593571653637,0.49027317865523923,0.2441206340604254,0.3770090785491864,0.41703140495867785,0.34513856559766776,0.5510808459985121,0.29588038902598335,-2.2573127229488676e-2,0.4373745701703231,-0.17067363265306135,0.4925563648976763,4.176290989865339e-2,1.3574020999574525,-0.12620113044319448,-1.129128347550079e-2,0.22830979618671932,0.24269187145557658,0.20893702506769118,0.748504102818458,0.18458626154255642,0.8835481493350426,1.1272978812325074,1.2915354273192108,0.2876686390532541,0.0,0.9904887075962543,0.4432600740985384],
        [-0.5608862043474047,1.1139119890609814,0.0,0.5005955401768551,0.17854956715798775,0.15806105582728947,0.18033819864720546,-0.4802707248263889,0.6846566363771782,-7.279328302688914e-2,0.36979854904624965,0.1752177829827486,0.8645933568952457,-0.20656585074116796,0.17436158002295588,0.22710894240850021,0.10595833386101994,0.18079866666666677,-6.484946818099868e-2,0.1716198580538304,0.3424860670194003,-0.20820143294770144,0.3273796944556171,-0.2430813157023699,0.13842378121284193,0.0,5.0791962302445315e-2,5.7639889196676064e-2,0.12808111415418688,-0.2521329274154783],
        [0.13658543909433507,-1.3616696747371426e-2,0.5030605349346549,0.2378682670847374,1.944850889701777e-2,0.7038710851053824,0.9651296209975258,1.3294305684110599,-2.4758430139697696e-2,0.3271992384993021,0.6314412484997738,0.24527780091628504,1.6153888209399163,0.2116278947363579,0.5497781249999998,0.0,0.3343674990091161,0.2833496536087008,0.7848339278636547,0.964176135980281,0.29953449683807754,0.4480734693877553,2.752694253306931e-2,0.6559338842975206,0.3615286908530153,0.4432348521552185,2.901670333346949,0.6157396449704142,0.3216792292267774,0.4024094453107596],
        [0.2906764308083154,2.254484837040288,0.28306347554630595,-0.4348612687149239,0.6338501450732545,0.19060336369038589,0.3605507070370515,0.32465306122448956,0.6476934160052708,-0.14222336000000002,9.961399974185525e-2,0.43013892727249603,3.387274038884991e-2,0.0,0.22924128053727033,0.3091545986586357,0.2466878652559148,0.7692607743063029,0.4400063878441691,0.4490579417013685,1.052789111619496,0.717479275684886,1.193822944882252,0.5242678881710849,0.8037563259231855,0.20020797675245983,0.11646946504147726,0.44617422544781604,0.646175641780995,0.2660154482839263],
        [0.15158458419960952,-2.103610675038281e-4,0.23590187010687047,0.5185792426536437,-0.1758733653857597,0.23811431940051464,-0.28090245864951946,0.161579536285267,0.4906371909239662,-7.962793938394275e-2,-2.0854020074995816e-2,-5.206726094171976e-2,0.7687362241687561,-0.11130172597192756,0.6150438639665199,0.10844102269462796,5.8941197218477015e-2,0.11670019997049619,1.1342866548505675,-0.21365592125362054,0.0,4.054610177418727e-2,0.6274109161213564,-0.15976401695361608,0.23570216616480555,-0.3155618222134443,0.0,1.8386871661651347,0.4414668932420607,-0.5396987118119454],
        [0.1334582775267179,0.4007757804387311,1.0654203777099078,0.0,0.7961919218960933,0.481956223182626,0.17041978940231384,6.364067034307164e-2,0.6046293616733063,2.3411296642704915e-2,5.787695038059537e-3,0.3232391376561681,0.5785054876429259,0.3190982977440311,0.7621780499671844,0.37565335726903704,1.885713163204362,-7.078717201166174e-2,8.901660635887576e-2,8.213748831987044e-2,0.12680111097693514,0.49944133694381665,0.6186227923836143,0.30441777138958726,0.657181108492551,0.6482449324211925,0.31826625474487047,0.33012503759721556,5.037477159099146e-2,0.39210943910459806],
        [-0.12094298801226577,2.8135549144517435e-2,1.4974554582946196,0.0,-0.21250691974130798,-8.928188570922102e-2,0.0,-0.25644797367954597,-0.22815880963247337,0.8382873013956216,0.0,-0.16572318211365145,0.15204081499982447,0.20531034645345914,0.5955783381364876,-0.3803981481481482,5.168360741397793e-2,0.15763300388723622,0.1091348458381054,0.15249568564980764,0.5479676035502958,-0.310400083255739,0.15812060857246757,-0.5616226726932256,-0.41379415923601914,0.9948179440046501,-0.5078819047619049,-5.6321672231092856e-2,0.8811837633281596,0.17336206595301062],
        [-0.1228620921913447,0.5677250198299677,1.2778130959949063e-2,-7.609084738146255e-2,-0.6277713587681726,0.4099100970659184,-0.38503533572717497,-0.42268533621606874,-0.4744205714285714,-0.48491914091943433,-0.6113215019430213,-0.786771042893835,-0.45170650565017856,-0.1935987759670943,-0.44389666904333824,-0.25625820979545877,-0.5004216503480889,-0.38855061238779853,-2.7664218139162866e-2,-0.3040487654320988,3.823402288551869e-2,-0.34761316443085666,1.736501377410482e-2,-0.20379437736813366,-0.3347315192743764,0.0,-0.45649799608391917,-0.3345995490638173,-3.593182964932373e-2,-0.1273208870154504],
        [0.0,6.674490475098382e-2,0.48533746462067917,0.4991966276625117,0.6920620942605971,2.5536871506769545,1.5621168926612987,1.1832388153749211,0.5941208470518455,0.28098461538461517,0.9266651576882454,9.964382106389902e-2,0.34761333333333355,0.7355719537535297,0.8734041327593971,0.1998391585279744,0.11219039773423556,3.7894391366888396,0.0,0.39093968485860375,0.4999140372582269,0.35615048984146647,0.761086817006694,0.42916736274211154,7.502242309170737e-2,0.5079330006947942,1.1759002306550306,1.2132698605380519,-0.6795989149229351,0.1836662765307011],
        [0.9071729853382402,1.093527023144949,0.26163205807104184,0.35537005131025867,-9.005604738724671e-2,0.2507171684400473,0.23536606903408552,0.6165205146792041,0.40450455746663083,2.8603431511196264e-2,-0.11703282078581523,0.4113571548564676,0.5500233487725699,6.976791333423105e-2,0.19316682776885385,-0.12818667421822982,0.2312678426651884,8.069056108087813e-2,0.24703503190857656,1.1645178572414854,-5.963474674853453e-2,-0.2644372146451266,-1.5452959183673398e-2,-7.165269389518791e-2,0.45680527378336433,-0.1298674701653264,0.47414403355340595,-4.7362943309308236e-2,-3.09907323763301e-2,5.6071905303966885e-2],
        [-0.1386827567909764,0.752439963178493,-0.13162307468436973,-0.4898295340384857,-0.29281897299512905,-0.12508248979797854,-0.4824411862150041,1.0585801821183738e-2,0.15492529545589218,1.2357322846164478,4.035911630242839e-2,2.722421665954866e-2,0.3007378047885383,-0.39671339635562086,0.10425491276400378,-0.3177001572204853,-5.3414525106522115e-3,7.118964577702114e-2,0.18139970660855198,-0.23492386239440166,-9.391899275410442e-2,-0.19220409698710728,-0.1970381648738897,-0.5614140655954194,-0.42120319566265685,-0.19717685235262294,0.17661768283976187,0.0,0.6261903876956749,-0.19884674021171445],
        [0.26797487012532883,0.2968820858518688,0.2223350411789191,-8.144785939374777e-2,9.916118465534973e-2,-9.718058665047613e-2,0.31481857544670455,0.4148738563106349,0.17445401611911748,0.3805656699825981,0.12087495962667205,0.3439822520088829,0.2453694068678458,-0.30360810654153225,-0.27444783258285643,0.3891634321103161,-5.3342815397949495e-2,0.2691668287205251,-0.19668221290817445,7.437223601307763e-2,-0.39827389166391525,9.33258067927456e-3,3.0472440944881996e-3,-0.1473274520830019,-0.3227446523930353,1.2832870285379383,0.14534374216449297,0.2725441015077146,0.25448462660841153,-2.9939060937761997e-2],
        [0.9765531849233404,0.5821481481481483,0.39232217673332004,0.30110890880090047,0.34609924075295706,1.0246514468789631,0.37571966214362473,0.3989257433565656,0.4580877797461853,0.30879046685805234,0.20004281254550804,0.3276378130222608,0.16835104651795274,-0.24912104035796034,-0.34262611507469787,-0.29244734855925814,0.2852627621111983,0.6506615714251376,1.2322722117202267,0.8704449742217679,0.7141546952357765,0.6076519577571411,-0.28902846062028087,0.0,0.25195616415884237,0.49399179702525653,8.317901171683628e-3,0.20852347303195873,0.37600679527766,0.3193383655634987]
]

def results_for_donation_ratio(donation_ratio, num_years=20, print_results=True):
    global rets
    """
    donation_ratio: fraction of portfolio to be donated
    """
    num_holdings = 30.0
    donation_target = num_holdings * donation_ratio
    income_tax = 0.36  # in California
    cap_gains_tax = 0.23
    
    rets = rets[:num_years]
    
    donations = []
    cap_gains = []
    taxes = []
    for y in rets:
        y.sort()
        y.reverse()
        cutoff = 0
        for i in range(1, len(y) + 1):
            if sum([ 1 + x for x in y[:i] ]) <= donation_target:
                cutoff = i
            else:
                break
                    
        frac = (donation_target - sum(y[:cutoff])) / (1 + y[cutoff])
        cap_gain = sum(y[cutoff:]) - y[cutoff] * frac
        donations.append(sum(y[:cutoff]) + (1 + y[cutoff]) * frac)
        cap_gains.append(cap_gain)
        if cap_gains > 0:
            taxes.append(cap_gain * cap_gains_tax)
        else:
            taxes.append(-cap_gain * income_tax)

    pre_tax_ret = reduce(lambda x, y: x * y, [np.average([1 + x for x in y]) for (y, tax) in zip(rets, taxes)], 1)
    
    # Returns if you rebalance every year
    post_tax_ret = reduce(lambda x, y: x * y, [np.average([1 + x for x in y]) * (1 - tax/30) for (y, tax) in zip(rets, taxes)], 1)**(1.0 / len(rets))

    # Returns if you only incur tax at the end
    etf_ret = (pre_tax_ret * (1 - cap_gains_tax))**(1.0 / len(rets))

    if print_results:
        print "Donations:", np.average(donations)
        print "Cap. gains:", np.average(cap_gains)
        print "Taxes:", np.average(taxes)
        print "Pre-tax Returns:", pre_tax_ret**(1.0 / len(rets))

        print "Post-tax Returns:", post_tax_ret
        
        print "ETF returns:", etf_ret

    return post_tax_ret, etf_ret

results_for_donation_ratio(0.0)
results_for_donation_ratio(0.2)
